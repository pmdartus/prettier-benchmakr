name: Performance benchmark

on:
  workflow_dispatch:
    inputs:
      baseline:
        description: "Baseline Prettier commit or version"
        default: "latest"

      target:
        description: "Target Prettier commit or version"

      runs:
        description: "Number of runs"
        required: true
        default: 10

env:
  node_version: 20
  hyperfine_version: 1.16.1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node_version }}

      - name: Install dependencies
        run: npm install

      - name: Install misc. dependencies
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v${{ env.hyperfine_version }}/hyperfine_${{ env.hyperfine_version }}_amd64.deb
          sudo dpkg -i hyperfine_${{ env.hyperfine_version }}_amd64.deb

      - name: Install baseline Prettier
        run: |
          npm install --no-save prettier-baseline@npm:prettier@${{ inputs.baseline }}
          echo "BASELINE_BIN=$PWD/node_modules/prettier-baseline/bin/prettier.cjs" >> $GITHUB_ENV

      - name: Install target Prettier
        if: ${{ inputs.target }}
        run: |
          npm install --no-save prettier-target@npm:prettier@${{ inputs.target }}
          echo "TARGET_BIN=$PWD/node_modules/prettier-target/bin/prettier.cjs" >> $GITHUB_ENV

      - name: Print binary versions
        run: |
          ls -la node_modules

      - name: Run benchmark
        run: node ./scripts/benchmark.js --fo
